# devops-project-3

GitOps example on GKE with Terraform, k8s, and Github actions


## Repositories

| Link                                                            | Description           |
| --------------------------------------------------------------- | --------------------- |
| [Repo Link](https://github.com/ansnoussi/gitops-example-app)    | Example GitOps App    |
| [Repo Link](https://github.com/ansnoussi/gitops-example-deploy) | Example GitOps Deploy |
| [Repo Link](https://github.com/ansnoussi/gitops-example-infra/) | Example GitOps Infra  |

# Working Demo



https://user-images.githubusercontent.com/33237270/134787877-1fca2485-e891-4186-a854-1520906bc001.mp4



## Overview

![Architecture Description](./overview.drawio.svg)

## Steps

**Step 0** (**Optional**) : If you have an existing k8s cluster, this steps uses Terraform to create a new cluster.
**Step 1** : There are 2 ways to trigger a release

- A developer updates the repo containing the [app repo](https://github.com/ansnoussi/gitops-example-app).
- An operator changes the deployment code in the [deployment repo](https://github.com/ansnoussi/gitops-example-deploy).

**Step 2** : Pushing or merging the change to the main branch of the app repo triggers a Docker build process.

**Step 3** : If the Docker image build is successful, it is pushed to the Docker image repository, and has a unique hash given to it as the image reference.

**Step 4** : Following the Docker image push, the deployment Git repository is updated with the new image reference.

**Step 5** : Following the Docker image push, the deployment Git repository is updated with the new image reference.

**Step 6** : Flux controller detects changes in deployment repo repository and apply them to the workload running in the cluster.


## Provision Cluster (GCP)

#### Prerequisites

Make sure to have :

- gcloud clie installed locally and authenticated to your gcp account.
  - authenticate with : `gcloud auth login`
  - update components just in case : `gcloud components update`
- have kubectl installed
- have Terraform installed

#### Steps

1. clone the [Infra Repo](https://github.com/ansnoussi/gitops-example-infra/) into your local machine.
2. checkout to the gcp branch : `git checkout gcp`
3. create a `terrafrom.tfvars` containing the required vqriables:
   - `cluster_name` : Name you give your cluster
   - `linux_admin_password` : Password for the hosts in your cluster
   - `gcp_project_name` : The ID of your Google Cloud project
   - `gcp_project_region` : The region in which the cluster should be located
   - `node_locations` : Zones in which nodes should be placed
   - `cluster_cp_location` : Zone for control plane
4. Run `terraform init`
5. Run `terraform plan -var-file="terrafrom.tfvars"`
6. Run `terraform apply -var-file="terrafrom.tfvars"`
7. Get kubectl credentials from Google

```
gcloud container clusters get-credentials <CLUSTER NAME> --zone <CLUSTER CP LOCATION>
```

8. Check you have access by running : `kubectl cluster-info`
9. Create the `gitops-example` namespace : `kubectl create namespace gitops-example`
10. After finishing withe the project : `terraform destroy` to delete the k8s cluster and `kubectl config unset contexts` to remove the context from `kubectl`

## Secrets And Keys

#### Docker Registry Login Secret Setup

To do this you create two secrets in the `gitops-example-app` repository

- `DOCKER_USER` : Contains your Docker registry username (add this to `gitops-example-deploy` too)
- `DOCKER_PASSWORD` : Contains your Docker registry password

Next, you set up your Kubernetes cluster so it has these credentials.

```
kubectl create -n gitops-example secret docker-registry regcred --docker-server=docker.io --docker-username=$DOCKER_USER --docker-password=$DOCKER_PASSWORD --docker-email=$DOCKER_EMAIL
```

#### Repository Access Token

- First create a [personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) in Github.

- Name the token `EXAMPLE_GITOPS_DEPLOY_TRIGGER` and give it all permissions on `repo`

- Copy that token value into a secret with the same name `EXAMPLE_GITOPS_DEPLOY_TRIGGER` in your `gitops-example-app`

#### Install And Set Up FluxCD

- Run these commands to setup FluxCD on the cluster

```
kubectl create clusterrolebinding "cluster-admin-$(whoami)" --clusterrole=cluster-admin --user="$(gcloud config get-value core/account)"
kubectl create ns flux
fluxctl install --git-branch main --git-user=<YOUR GITHUB USERNAME> --git-email=<YOUR GITHUB EMAIL> --git-url=git@github.com:<YOUR GITHUB USERNAME>/gitops-example-deploy --git-path=namespaces,workloads --namespace=flux | kubectl apply -f -
```

- When the installation is complete, this command will return a key generated by FluxCD

```
fluxctl identity --k8s-fwd-ns flux
```

- You need to take this key, and place it in the gitops-example-deploy repository at this link:`https://github.com/<YOUR GITHUB USERNAME>/gitops-example-deploy/settings/keys/new`

  - Call the key `flux`
  - Tick the `write access` option
  - Click **Add Key**

- You have now set up all the secrets that need setting up to make the flow work.

## Build And Run Your Application

To deploy your application, all you need to do is make a change to the application in your gitops-example-app repository.
